// ============================================================================
// Pine ScriptÂ® ë¼ì´ì„ ìŠ¤: Mozilla Public License 2.0
// https://mozilla.org/MPL/2.0/
// ============================================================================
//
// ã€ì „ëµ ì„¤ëª…ã€‘
// Larry Williamsì˜ ì›ì¡° Blue Sky Day ì „ëµ
// "í‘¸ë¥¸ í•˜ëŠ˜ì²˜ëŸ¼ ìœ„ë¡œ ì €í•­ì´ ì—†ë‹¤" - ì‹ ê³ ê°€ ëŒíŒŒ ëª¨ë©˜í…€ ì „ëµ
//
// ã€í•µì‹¬ ê°œë…ã€‘
// Blue Sky Dayë€ ì£¼ê°€ê°€ ì „ì¼ ê³ ê°€ë¥¼ ëŒíŒŒí•˜ë©° ê°•í•œ ìƒìŠ¹ ëª¨ë©˜í…€ì„ ë³´ì´ëŠ” ë‚ ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
// ì‹ ê³ ê°€ ì˜ì—­ì—ì„œëŠ” ë§¤ë„ ì €í•­ì´ ì—†ì–´ ì¶”ê°€ ìƒìŠ¹ ê°€ëŠ¥ì„±ì´ ë†’ë‹¤ëŠ” ë…¼ë¦¬ì…ë‹ˆë‹¤.
//
// ã€ì§„ì… ì¡°ê±´ã€‘
// 1. ë‹¹ì¼ ì¢…ê°€ > ì „ì¼ ê³ ê°€ (ìƒë°© ëŒíŒŒ)
// 2. ê°•í•œ ì–‘ë´‰: ì¢…ê°€ê°€ ë‹¹ì¼ ê³ ê°€ì˜ ì¼ì • ë¹„ìœ¨ ì´ìƒ (ì„ íƒì )
// 3. ê±°ë˜ëŸ‰ ì¦ê°€: í‰ê·  ê±°ë˜ëŸ‰ ëŒ€ë¹„ ì¦ê°€ (ì„ íƒì )
//
// ã€ì²­ì‚° ì¡°ê±´ã€‘
// - Nì¼ í›„ ì²­ì‚° (ê¸°ë³¸: 5ì¼)
// - ë˜ëŠ” ì†ì ˆ/ìµì ˆ ëª©í‘œ ë„ë‹¬ ì‹œ
//
// ã€ì°¸ê³ ã€‘
// - Larry Williamsì˜ ì €ì„œ "Long-Term Secrets to Short-Term Trading" ì°¸ì¡°
// - ë‹¨ê¸° íŠ¸ë ˆì´ë”©ì— ì í•©í•œ ëª¨ë©˜í…€ ì „ëµ
//
// ============================================================================

//@version=6
indicator("Larry Williams Blue Sky Day", shorttitle="Blue Sky Day", overlay=true, max_labels_count=500)


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 1 - ì…ë ¥ íŒŒë¼ë¯¸í„°ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// ê¸°ë³¸ ì„¤ì •
grp_basic = "ê¸°ë³¸ ì„¤ì •"
candleStrengthFilter = input.bool(true, "ê°•í•œ ì–‘ë´‰ í•„í„° ì‚¬ìš©", group=grp_basic, tooltip="ì¢…ê°€ê°€ ë‹¹ì¼ ê³ ê°€ ê·¼ì²˜ì—ì„œ ë§ˆê°í•˜ëŠ” ê°•í•œ ì–‘ë´‰ë§Œ í•„í„°ë§")
candleStrengthPercent = input.float(70.0, "ì–‘ë´‰ ê°•ë„ (%)", minval=50.0, maxval=100.0, step=5.0, group=grp_basic, tooltip="ì¢…ê°€ê°€ ë‹¹ì¼ ë²”ìœ„ì˜ ìƒìœ„ N% ì´ë‚´")

// ê±°ë˜ëŸ‰ í•„í„°
grp_volume = "ê±°ë˜ëŸ‰ í•„í„°"
useVolumeFilter = input.bool(false, "ê±°ë˜ëŸ‰ í•„í„° ì‚¬ìš©", group=grp_volume)
volumeMaPeriod = input.int(20, "ê±°ë˜ëŸ‰ MA ê¸°ê°„", minval=5, maxval=50, group=grp_volume)
volumeMultiplier = input.float(1.5, "ê±°ë˜ëŸ‰ ë°°ìˆ˜", minval=1.0, maxval=5.0, step=0.1, group=grp_volume, tooltip="í‰ê·  ê±°ë˜ëŸ‰ ëŒ€ë¹„ ì´ ë°°ìˆ˜ ì´ìƒì¼ ë•Œë§Œ ì‹ í˜¸")

// ì²­ì‚° ì„¤ì •
grp_exit = "ì²­ì‚° ì„¤ì •"
holdingDays = input.int(5, "ë³´ìœ  ê¸°ê°„ (ì¼)", minval=1, maxval=20, group=grp_exit, tooltip="Blue Sky Day ë°œìƒ í›„ ëª‡ ë´‰ ë™ì•ˆ ë³´ìœ ")
useStopLoss = input.bool(true, "ì†ì ˆ ì‚¬ìš©", group=grp_exit)
stopLossPercent = input.float(3.0, "ì†ì ˆ (%)", minval=0.5, maxval=10.0, step=0.5, group=grp_exit)
useTakeProfit = input.bool(true, "ìµì ˆ ì‚¬ìš©", group=grp_exit)
takeProfitPercent = input.float(5.0, "ìµì ˆ (%)", minval=1.0, maxval=20.0, step=0.5, group=grp_exit)

// ìˆ ì „ëµ (Blue Sky Day ë°˜ëŒ€ - í•˜ë½ ëŒíŒŒ)
grp_short = "ìˆ ì „ëµ (Red Sky Day)"
enableShort = input.bool(true, "ìˆ ì‹ í˜¸ í™œì„±í™”", group=grp_short, tooltip="ì¢…ê°€ê°€ ì „ì¼ ì €ê°€ ì•„ë˜ë¡œ ëŒíŒŒ ì‹œ ìˆ ì‹ í˜¸")

// ì‹œê°í™” ì„¤ì •
grp_visual = "ì‹œê°í™”"
showLabels = input.bool(true, "ì‹ í˜¸ ë¼ë²¨ í‘œì‹œ", group=grp_visual)
showPrevHighLow = input.bool(true, "ì „ì¼ ê³ /ì €ê°€ ë¼ì¸ í‘œì‹œ", group=grp_visual)
showExitLabels = input.bool(true, "ì²­ì‚° ì‹ í˜¸ í‘œì‹œ", group=grp_visual)

// ì•Œë¦¼ ì„¤ì •
grp_alert = "ì•Œë¦¼"
enableAlerts = input.bool(true, "ì•Œë¦¼ í™œì„±í™”", group=grp_alert)


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 2 - í•µì‹¬ ê³„ì‚°ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// ì „ì¼ ê³ ê°€/ì €ê°€
prevHigh = high[1]
prevLow = low[1]

// ë‹¹ì¼ ë²”ìœ„ ë° ì¢…ê°€ ìœ„ì¹˜
dayRange = high - low
closePosition = dayRange > 0 ? (close - low) / dayRange * 100 : 50  // 0-100%

// ê±°ë˜ëŸ‰ MA
volumeMa = ta.sma(volume, volumeMaPeriod)
isHighVolume = volume > volumeMa * volumeMultiplier

// === Blue Sky Day ì¡°ê±´ (ë¡±) ===
// 1. ì¢…ê°€ê°€ ì „ì¼ ê³ ê°€ë¥¼ ëŒíŒŒ
breakoutAbove = close > prevHigh

// 2. ê°•í•œ ì–‘ë´‰ í•„í„° (ì„ íƒì )
isStrongBullish = not candleStrengthFilter or closePosition >= candleStrengthPercent

// 3. ê±°ë˜ëŸ‰ í•„í„° (ì„ íƒì )
volumeCondition = not useVolumeFilter or isHighVolume

// Blue Sky Day ìµœì¢… ì‹ í˜¸
blueSkyDay = breakoutAbove and isStrongBullish and volumeCondition and barstate.isconfirmed

// === Red Sky Day ì¡°ê±´ (ìˆ) ===
// ì¢…ê°€ê°€ ì „ì¼ ì €ê°€ë¥¼ í•˜í–¥ ëŒíŒŒ
breakoutBelow = close < prevLow

// ê°•í•œ ìŒë´‰ í•„í„°
isStrongBearish = not candleStrengthFilter or closePosition <= (100 - candleStrengthPercent)

// Red Sky Day ìµœì¢… ì‹ í˜¸
redSkyDay = enableShort and breakoutBelow and isStrongBearish and volumeCondition and barstate.isconfirmed


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 3 - í¬ì§€ì…˜ ì¶”ì ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// í¬ì§€ì…˜ ìƒíƒœ ì¶”ì 
var bool inLongPosition = false
var bool inShortPosition = false
var float entryPrice = na
var int entryBar = na
var int positionType = 0  // 0: ì—†ìŒ, 1: ë¡±, -1: ìˆ

// ì²­ì‚° ì¡°ê±´ ê³„ì‚°
barsHeld = bar_index - entryBar
stopLossHit = positionType == 1 ? close < entryPrice * (1 - stopLossPercent / 100) :
              positionType == -1 ? close > entryPrice * (1 + stopLossPercent / 100) : false
takeProfitHit = positionType == 1 ? close > entryPrice * (1 + takeProfitPercent / 100) :
                positionType == -1 ? close < entryPrice * (1 - takeProfitPercent / 100) : false
timeExit = barsHeld >= holdingDays

// ì²­ì‚° ì‹ í˜¸
exitLong = inLongPosition and barstate.isconfirmed and (timeExit or (useStopLoss and stopLossHit) or (useTakeProfit and takeProfitHit))
exitShort = inShortPosition and barstate.isconfirmed and (timeExit or (useStopLoss and stopLossHit) or (useTakeProfit and takeProfitHit))

// í¬ì§€ì…˜ ì—…ë°ì´íŠ¸
if blueSkyDay and not inLongPosition and not inShortPosition
    inLongPosition := true
    positionType := 1
    entryPrice := close
    entryBar := bar_index

if redSkyDay and not inLongPosition and not inShortPosition
    inShortPosition := true
    positionType := -1
    entryPrice := close
    entryBar := bar_index

if exitLong
    inLongPosition := false
    positionType := 0
    entryPrice := na
    entryBar := na

if exitShort
    inShortPosition := false
    positionType := 0
    entryPrice := na
    entryBar := na


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 4 - ì‹œê°í™”ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// ì „ì¼ ê³ /ì €ê°€ ë¼ì¸
plot(showPrevHighLow ? prevHigh : na, "ì „ì¼ ê³ ê°€", color=color.new(color.green, 70), style=plot.style_stepline, linewidth=1)
plot(showPrevHighLow ? prevLow : na, "ì „ì¼ ì €ê°€", color=color.new(color.red, 70), style=plot.style_stepline, linewidth=1)

// Blue Sky Day ì‹ í˜¸ ë¼ë²¨
if showLabels and blueSkyDay
    label.new(bar_index, low, "ğŸš€\nBlue Sky",
              style=label.style_label_up,
              color=color.new(color.blue, 20),
              textcolor=color.white,
              size=size.small)

// Red Sky Day ì‹ í˜¸ ë¼ë²¨
if showLabels and redSkyDay
    label.new(bar_index, high, "Red Sky\nğŸ”»",
              style=label.style_label_down,
              color=color.new(color.red, 20),
              textcolor=color.white,
              size=size.small)

// ì²­ì‚° ë¼ë²¨
if showExitLabels and exitLong
    exitReason = stopLossHit ? "SL" : takeProfitHit ? "TP" : "TIME"
    label.new(bar_index, high, "Exit\n" + exitReason,
              style=label.style_label_down,
              color=color.new(color.gray, 30),
              textcolor=color.white,
              size=size.tiny)

if showExitLabels and exitShort
    exitReason = stopLossHit ? "SL" : takeProfitHit ? "TP" : "TIME"
    label.new(bar_index, low, "Exit\n" + exitReason,
              style=label.style_label_up,
              color=color.new(color.gray, 30),
              textcolor=color.white,
              size=size.tiny)

// ë°°ê²½ìƒ‰
bgcolor(blueSkyDay ? color.new(color.blue, 90) : na, title="Blue Sky Day ë°°ê²½")
bgcolor(redSkyDay ? color.new(color.red, 90) : na, title="Red Sky Day ë°°ê²½")

// í¬ì§€ì…˜ ì§„í–‰ ì¤‘ í‘œì‹œ
bgcolor(inLongPosition ? color.new(color.green, 95) : na, title="ë¡± í¬ì§€ì…˜ ë°°ê²½")
bgcolor(inShortPosition ? color.new(color.red, 95) : na, title="ìˆ í¬ì§€ì…˜ ë°°ê²½")


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 5 - ì•Œë¦¼ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// Alert conditions
alertcondition(blueSkyDay, title="Blue Sky Day ë¡±", message="ğŸš€ {{ticker}} | Blue Sky Day ë°œìƒ! ì¢…ê°€({{close}})ê°€ ì „ì¼ ê³ ê°€ ëŒíŒŒ")
alertcondition(redSkyDay, title="Red Sky Day ìˆ", message="ğŸ”» {{ticker}} | Red Sky Day ë°œìƒ! ì¢…ê°€({{close}})ê°€ ì „ì¼ ì €ê°€ í•˜í–¥ ëŒíŒŒ")
alertcondition(exitLong, title="ë¡± ì²­ì‚°", message="ğŸ“¤ {{ticker}} | ë¡± í¬ì§€ì…˜ ì²­ì‚°")
alertcondition(exitShort, title="ìˆ ì²­ì‚°", message="ğŸ“¤ {{ticker}} | ìˆ í¬ì§€ì…˜ ì²­ì‚°")

// í†µí•© ì•Œë¦¼
if enableAlerts and blueSkyDay
    alert(str.format("ğŸš€ {0} | Blue Sky Day! | ì¢…ê°€: {1} > ì „ì¼ê³ ê°€: {2}", syminfo.ticker, str.tostring(close, format.mintick), str.tostring(prevHigh, format.mintick)), alert.freq_once_per_bar_close)

if enableAlerts and redSkyDay
    alert(str.format("ğŸ”» {0} | Red Sky Day! | ì¢…ê°€: {1} < ì „ì¼ì €ê°€: {2}", syminfo.ticker, str.tostring(close, format.mintick), str.tostring(prevLow, format.mintick)), alert.freq_once_per_bar_close)


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 6 - ì •ë³´ í…Œì´ë¸”ã€‘
////////////////////////////////////////////////////////////////////////////////////////

var table infoTable = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    table.cell(infoTable, 0, 0, "Blue Sky Day", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "Larry Williams", text_color=color.blue, text_size=size.small)

    table.cell(infoTable, 0, 1, "ì „ì¼ ê³ ê°€", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 1, str.tostring(prevHigh, format.mintick), text_color=color.green, text_size=size.tiny)

    table.cell(infoTable, 0, 2, "ì „ì¼ ì €ê°€", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 2, str.tostring(prevLow, format.mintick), text_color=color.red, text_size=size.tiny)

    table.cell(infoTable, 0, 3, "í˜„ì¬ ì¢…ê°€", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 3, str.tostring(close, format.mintick), text_color=color.white, text_size=size.tiny)

    table.cell(infoTable, 0, 4, "ì–‘ë´‰ ê°•ë„", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 4, str.tostring(closePosition, "#.#") + "%", text_color=closePosition >= 70 ? color.green : color.orange, text_size=size.tiny)

    positionStatus = inLongPosition ? "ğŸŸ¢ ë¡±" : inShortPosition ? "ğŸ”´ ìˆ" : "âšª ì—†ìŒ"
    table.cell(infoTable, 0, 5, "í¬ì§€ì…˜", text_color=color.gray, text_size=size.tiny)
    table.cell(infoTable, 1, 5, positionStatus, text_color=color.white, text_size=size.tiny)
