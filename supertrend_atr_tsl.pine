// ============================================================================
// Pine ScriptÂ® ë¼ì´ì„ ìŠ¤: MIT License
// ì›ë³¸ ì‘ì„±ì: Mauricio Pimenta (@exit490) - 2019ë…„ 8ì›”
// v6 ì—…ê·¸ë ˆì´ë“œ: 2024ë…„
// ============================================================================
//
// ã€ì „ëµ ì„¤ëª…ã€‘
// SuperTrend ATR with Trailing Stop Loss
// ATR(Average True Range) ê¸°ë°˜ ë³€ë™ì„± ì¶”ì„¸ ì¶”ì  ì „ëµ
//
// ã€í•µì‹¬ ê°œë…ã€‘
// SuperTrendëŠ” ë³€ë™ì„±(ATR)ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ì´ë™ ìŠ¤íƒ‘ ë° ë°˜ì „ ë¼ì¸ì…ë‹ˆë‹¤.
// ê°€ê²©ì´ 1% ì´ë™í•  ë•Œë§ˆë‹¤ ìŠ¤íƒ‘ë¡œìŠ¤ë¥¼ ìƒí–¥ ì¡°ì •í•©ë‹ˆë‹¤.
// ì‹œì¥ ê°€ê²©ì´ ìŠ¤íƒ‘ë¡œìŠ¤ë¥¼ êµì°¨í•˜ë©´ í¬ì§€ì…˜ì„ ì²­ì‚°í•©ë‹ˆë‹¤.
//
// ã€íŒŒë¼ë¯¸í„°ã€‘
// - ATR Period: ATR ê³„ì‚°ì— ì‚¬ìš©í•  ë´‰ ìˆ˜ (ê¸°ë³¸: 1)
// - ATR Multiplier: ë³€ë™ì„±ì— ì ìš©í•  ë°°ìˆ˜ (ê¸°ë³¸: 3.0)
// - Initial Stop Loss: ì´ˆê¸° ìŠ¤íƒ‘ë¡œìŠ¤ ë¹„ìœ¨ (ê¸°ë³¸: 3%)
// - Trailing Step: ìŠ¤íƒ‘ ìƒí–¥ ì¡°ì • ê¸°ì¤€ (ê¸°ë³¸: 1%)
//
// ã€ì›ë³¸ ì¶œì²˜ã€‘
// TradingView: PUB;KbFajXHaZXIoaiN4VjSipG6Y0srYWsd1
// ì‘ì„±ì: @exit490
//
// ============================================================================

//@version=6
indicator("SuperTrend ATR + Trailing Stop Loss", shorttitle="SuperTrend TSL", overlay=true, max_labels_count=500)


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 1 - ì…ë ¥ íŒŒë¼ë¯¸í„°ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// SuperTrend ì„¤ì •
grp_supertrend = "SuperTrend ì„¤ì •"
atrPeriod = input.int(1, "ATR ê¸°ê°„", minval=1, maxval=50, group=grp_supertrend, tooltip="ATR ê³„ì‚°ì— ì‚¬ìš©í•  ë´‰ ìˆ˜")
atrMultiplier = input.float(3.0, "ATR ë°°ìˆ˜", minval=0.5, maxval=10.0, step=0.1, group=grp_supertrend, tooltip="ATRì— ê³±í•  ë°°ìˆ˜ (í´ìˆ˜ë¡ ì‹ í˜¸ ì ìŒ)")

// Trailing Stop ì„¤ì •
grp_tsl = "Trailing Stop Loss ì„¤ì •"
initialStopLossPercent = input.float(3.0, "ì´ˆê¸° ì†ì ˆ (%)", minval=0.5, maxval=20.0, step=0.5, group=grp_tsl, tooltip="ì§„ì… ì‹œ ì´ˆê¸° ì†ì ˆ ë¹„ìœ¨")
trailingStep = input.float(1.0, "íŠ¸ë ˆì¼ë§ ìŠ¤í… (%)", minval=0.5, maxval=5.0, step=0.5, group=grp_tsl, tooltip="ì´ ë¹„ìœ¨ë§Œí¼ ìˆ˜ìµ ë°œìƒ ì‹œ ìŠ¤íƒ‘ ìƒí–¥")

// í¬ì§€ì…˜ ì„¤ì •
grp_position = "í¬ì§€ì…˜ ì„¤ì •"
positionType = input.string("BOTH", "í¬ì§€ì…˜ íƒ€ì…", options=["LONG", "SHORT", "BOTH"], group=grp_position)

// ì‹œê°í™” ì„¤ì •
grp_visual = "ì‹œê°í™”"
showSuperTrend = input.bool(true, "SuperTrend ë¼ì¸ í‘œì‹œ", group=grp_visual)
showSignals = input.bool(true, "ë§¤ìˆ˜/ë§¤ë„ ì‹ í˜¸ í‘œì‹œ", group=grp_visual)
showStopLoss = input.bool(true, "ì†ì ˆ ë¼ì¸ í‘œì‹œ", group=grp_visual)
showEntryPrice = input.bool(true, "ì§„ì…ê°€ í‘œì‹œ", group=grp_visual)
showInfoTable = input.bool(true, "ì •ë³´ í…Œì´ë¸” í‘œì‹œ", group=grp_visual)

// ì•Œë¦¼ ì„¤ì •
grp_alert = "ì•Œë¦¼"
enableAlerts = input.bool(true, "ì•Œë¦¼ í™œì„±í™”", group=grp_alert)


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 2 - SuperTrend ê³„ì‚°ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// ATR ê³„ì‚°
atr = atrMultiplier * ta.atr(atrPeriod)

// SuperTrend ë°´ë“œ ê³„ì‚°
var float longStop = na
var float shortStop = na

longStopCalc = hl2 - atr
shortStopCalc = hl2 + atr

// ì´ì „ ê°’ ì°¸ì¡°
longStopPrev = nz(longStop[1], longStopCalc)
shortStopPrev = nz(shortStop[1], shortStopCalc)

// ìŠ¤íƒ‘ ì—…ë°ì´íŠ¸ (ìƒìŠ¹ ì¶”ì„¸ì—ì„œëŠ” ìŠ¤íƒ‘ì„ ì˜¬ë¦¬ê³ , í•˜ë½ ì¶”ì„¸ì—ì„œëŠ” ìŠ¤íƒ‘ì„ ë‚´ë¦¼)
longStop := close[1] > longStopPrev ? math.max(longStopCalc, longStopPrev) : longStopCalc
shortStop := close[1] < shortStopPrev ? math.min(shortStopCalc, shortStopPrev) : shortStopCalc

// ì¶”ì„¸ ë°©í–¥ ê²°ì •
var int direction = 1
direction := nz(direction[1], direction)
direction := direction == -1 and close > shortStopPrev ? 1 : direction == 1 and close < longStopPrev ? -1 : direction

// SuperTrend ê°’ ë° ìƒ‰ìƒ
superTrendValue = direction == 1 ? longStop : shortStop
superTrendColor = direction == 1 ? color.green : color.red

// ì¶”ì„¸ ì „í™˜ ê°ì§€
buySignal = direction == 1 and direction[1] == -1
sellSignal = direction == -1 and direction[1] == 1


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 3 - Trailing Stop Loss ë¡œì§ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// í¬ì§€ì…˜ ìƒíƒœ ë³€ìˆ˜
var bool inLongPosition = false
var bool inShortPosition = false
var float entryPrice = na
var float currentStopLoss = na
var float updatedEntryPrice = na

// ë¡± í¬ì§€ì…˜ ë¡œì§
if positionType == "LONG" or positionType == "BOTH"
    // ì²­ì‚° ì¡°ê±´
    crossedStopLoss = inLongPosition and close <= currentStopLoss
    exitCondition = inLongPosition and (crossedStopLoss or sellSignal)

    if exitCondition
        inLongPosition := false
        entryPrice := na
        updatedEntryPrice := na
        currentStopLoss := na

    // ì§„ì… ì¡°ê±´
    entryCondition = not inLongPosition and not inShortPosition and buySignal

    if entryCondition
        inLongPosition := true
        entryPrice := close
        updatedEntryPrice := close
        currentStopLoss := close * (1 - initialStopLossPercent / 100)

    // Trailing Stop ì—…ë°ì´íŠ¸
    if inLongPosition
        profitPercent = (close - updatedEntryPrice) / updatedEntryPrice * 100
        if profitPercent >= trailingStep
            newStopLoss = updatedEntryPrice * (1 - initialStopLossPercent / 100 + profitPercent / 100 - trailingStep / 100)
            currentStopLoss := math.max(currentStopLoss, newStopLoss)
            updatedEntryPrice := close

// ìˆ í¬ì§€ì…˜ ë¡œì§
if positionType == "SHORT" or positionType == "BOTH"
    // ì²­ì‚° ì¡°ê±´
    crossedStopLoss = inShortPosition and close >= currentStopLoss
    exitCondition = inShortPosition and (crossedStopLoss or buySignal)

    if exitCondition
        inShortPosition := false
        entryPrice := na
        updatedEntryPrice := na
        currentStopLoss := na

    // ì§„ì… ì¡°ê±´
    entryCondition = not inLongPosition and not inShortPosition and sellSignal

    if entryCondition
        inShortPosition := true
        entryPrice := close
        updatedEntryPrice := close
        currentStopLoss := close * (1 + initialStopLossPercent / 100)

    // Trailing Stop ì—…ë°ì´íŠ¸
    if inShortPosition
        profitPercent = (updatedEntryPrice - close) / updatedEntryPrice * 100
        if profitPercent >= trailingStep
            newStopLoss = updatedEntryPrice * (1 + initialStopLossPercent / 100 - profitPercent / 100 + trailingStep / 100)
            currentStopLoss := math.min(currentStopLoss, newStopLoss)
            updatedEntryPrice := close


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 4 - ì‹œê°í™”ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// SuperTrend ë¼ì¸
plot(showSuperTrend ? superTrendValue : na, "SuperTrend", color=superTrendColor, linewidth=2, style=plot.style_linebr)

// ì§„ì…ê°€ í‘œì‹œ
plot(showEntryPrice and not na(entryPrice) ? entryPrice : na, "ì§„ì…ê°€", color=color.blue, style=plot.style_circles, linewidth=2)

// ì†ì ˆ ë¼ì¸ í‘œì‹œ
stopLossColor = inLongPosition ? color.new(color.red, 50) : inShortPosition ? color.new(color.red, 50) : na
plot(showStopLoss and not na(currentStopLoss) ? currentStopLoss : na, "ì†ì ˆ ë¼ì¸", color=stopLossColor, style=plot.style_circles, linewidth=1)

// ë§¤ìˆ˜/ë§¤ë„ ì‹ í˜¸ ë¼ë²¨
if showSignals and buySignal and (positionType == "LONG" or positionType == "BOTH")
    label.new(bar_index, longStop, "Buy",
              style=label.style_label_up,
              color=color.new(color.green, 0),
              textcolor=color.white,
              size=size.normal)

if showSignals and sellSignal and (positionType == "SHORT" or positionType == "BOTH")
    label.new(bar_index, shortStop, "Sell",
              style=label.style_label_down,
              color=color.new(color.red, 0),
              textcolor=color.white,
              size=size.normal)

// ë°°ê²½ìƒ‰
bgcolor(inLongPosition ? color.new(color.green, 95) : na, title="ë¡± í¬ì§€ì…˜")
bgcolor(inShortPosition ? color.new(color.red, 95) : na, title="ìˆ í¬ì§€ì…˜")


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 5 - ì•Œë¦¼ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// Alert conditions
alertcondition(buySignal, title="Buy ì‹ í˜¸", message="ğŸŸ¢ {{ticker}} | SuperTrend Buy ì‹ í˜¸! ê°€ê²©: {{close}}")
alertcondition(sellSignal, title="Sell ì‹ í˜¸", message="ğŸ”´ {{ticker}} | SuperTrend Sell ì‹ í˜¸! ê°€ê²©: {{close}}")

// ì†ì ˆ ì•Œë¦¼
longStopHit = inLongPosition[1] and close <= currentStopLoss[1]
shortStopHit = inShortPosition[1] and close >= currentStopLoss[1]
alertcondition(longStopHit, title="ë¡± ì†ì ˆ", message="âš ï¸ {{ticker}} | ë¡± ì†ì ˆ ë„ë‹¬!")
alertcondition(shortStopHit, title="ìˆ ì†ì ˆ", message="âš ï¸ {{ticker}} | ìˆ ì†ì ˆ ë„ë‹¬!")

// ì‹¤ì‹œê°„ ì•Œë¦¼
if enableAlerts and buySignal and (positionType == "LONG" or positionType == "BOTH")
    alert(str.format("ğŸŸ¢ {0} | SuperTrend Buy | ê°€ê²©: {1}", syminfo.ticker, str.tostring(close, format.mintick)), alert.freq_once_per_bar_close)

if enableAlerts and sellSignal and (positionType == "SHORT" or positionType == "BOTH")
    alert(str.format("ğŸ”´ {0} | SuperTrend Sell | ê°€ê²©: {1}", syminfo.ticker, str.tostring(close, format.mintick)), alert.freq_once_per_bar_close)


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 6 - ì •ë³´ í…Œì´ë¸”ã€‘
////////////////////////////////////////////////////////////////////////////////////////

if showInfoTable
    var table infoTable = table.new(position.top_right, 2, 8, bgcolor=color.new(color.black, 80), border_width=1)

    if barstate.islast
        table.cell(infoTable, 0, 0, "SuperTrend TSL", text_color=color.white, text_size=size.small)
        table.cell(infoTable, 1, 0, "@exit490", text_color=color.gray, text_size=size.small)

        table.cell(infoTable, 0, 1, "ì¶”ì„¸", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 1, direction == 1 ? "ğŸŸ¢ ìƒìŠ¹" : "ğŸ”´ í•˜ë½", text_color=direction == 1 ? color.green : color.red, text_size=size.tiny)

        table.cell(infoTable, 0, 2, "SuperTrend", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 2, str.tostring(superTrendValue, format.mintick), text_color=superTrendColor, text_size=size.tiny)

        table.cell(infoTable, 0, 3, "ATR", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 3, str.tostring(atr, format.mintick), text_color=color.white, text_size=size.tiny)

        positionStatus = inLongPosition ? "ğŸŸ¢ ë¡±" : inShortPosition ? "ğŸ”´ ìˆ" : "âšª ì—†ìŒ"
        table.cell(infoTable, 0, 4, "í¬ì§€ì…˜", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 4, positionStatus, text_color=color.white, text_size=size.tiny)

        table.cell(infoTable, 0, 5, "ì§„ì…ê°€", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 5, na(entryPrice) ? "-" : str.tostring(entryPrice, format.mintick), text_color=color.blue, text_size=size.tiny)

        table.cell(infoTable, 0, 6, "ì†ì ˆê°€", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 6, na(currentStopLoss) ? "-" : str.tostring(currentStopLoss, format.mintick), text_color=color.red, text_size=size.tiny)

        // í˜„ì¬ ìˆ˜ìµë¥ 
        currentPnL = inLongPosition ? (close - entryPrice) / entryPrice * 100 :
                     inShortPosition ? (entryPrice - close) / entryPrice * 100 : 0.0
        table.cell(infoTable, 0, 7, "ìˆ˜ìµë¥ ", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 7, na(entryPrice) ? "-" : str.tostring(currentPnL, "#.##") + "%",
                   text_color=currentPnL >= 0 ? color.green : color.red, text_size=size.tiny)
