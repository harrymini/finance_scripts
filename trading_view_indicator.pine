// ============================================================================
// Pine ScriptÂ® ë¼ì´ì„ ìŠ¤: Mozilla Public License 2.0
// https://mozilla.org/MPL/2.0/
// Â© xavier_2sy
// ============================================================================
//
// ã€ì§€í‘œ ì„¤ëª…ã€‘
// ì´ ì§€í‘œëŠ” ë‹¤ì¤‘ íƒ€ì„í”„ë ˆì„ì—ì„œ Kì„ (ìº”ë“¤) ë°˜ì „ íŒ¨í„´ì„ ê°ì§€í•˜ëŠ” ê¸°ìˆ ì  ë¶„ì„ ë„êµ¬ì…ë‹ˆë‹¤.
//
// ì£¼ìš” íŠ¹ì§•:
// - 2ê°€ì§€ Kì„  ì—…ë°ì´íŠ¸ ëª¨ë“œ ì§€ì›
//   * ëª¨ë“œ 1: ê·¸ë¦¼ì(ê¼¬ë¦¬) ëŒíŒŒë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìƒìŠ¹/í•˜ë½ Kì„  ì—…ë°ì´íŠ¸ ë° ì „ë‹¬
//   * ëª¨ë“œ 2: ì‹¤ì²´(ëª¸í†µ) ëŒíŒŒë¥¼ ê¸°ì¤€ìœ¼ë¡œ Kì„  ì—…ë°ì´íŠ¸
// - ë¦¬í˜ì¸íŒ…(Repainting) ë¬¸ì œ í•´ê²°: ê³¼ê±° ì‹ í˜¸ê°€ ë³€ê²½ë˜ì§€ ì•ŠìŒ
// - 3ê°œì˜ íƒ€ì„í”„ë ˆì„ ë™ì‹œ ëª¨ë‹ˆí„°ë§ (í˜„ì¬, HTF_1, HTF_2)
//
// ã€ì—…ë°ì´íŠ¸ ì´ë ¥ã€‘
// - ë¡œì§ì„ ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ë¡œ ìº¡ìŠí™”í•˜ì—¬ í–¥í›„ HTF ì¶”ê°€ ìš©ì´
// - ì•Œê³ ë¦¬ì¦˜ ìµœì í™”ë¡œ ì‹¤í–‰ ì†ë„ í–¥ìƒ
// - ë³€ìˆ˜ëª… ê°œì„ ìœ¼ë¡œ ë‹¤ì¤‘ ì£¼ê¸° ê°œë°œ í¸ì˜ì„± ì¦ëŒ€
// - ë°˜ì „ ì‹¬ë³¼ ì‹œê°í™” ì¶”ê°€
// - ë°˜ì „ íŒë‹¨ìš© ìˆ˜í‰ì„  ì¶”ê°€
// - HTF_2 íƒ€ì„í”„ë ˆì„, ë°˜ì „, ì…ì¥, íŒë‹¨ì„  ê¸°ëŠ¥ ì¶”ê°€
// - ì…ë ¥ íŒ¨ë„ UI ê°œì„ 
// - í˜„ì¬ íƒ€ì„í”„ë ˆì„ì´ HTFë³´ë‹¤ í´ ë•Œ ë°œìƒí•˜ëŠ” ë²„ê·¸ ìˆ˜ì •
//   (ì´ ê²½ìš° ì§€í‘œëŠ” ì°¸ê³ ìš©ìœ¼ë¡œ ë¶€ì í•©)
//
// 2025/10/01 ì—…ë°ì´íŠ¸:
// - í˜„ì¬ ì£¼ê¸° ì¶”ê°€ (í€€íŠ¸ íŠ¸ë ˆì´ë”© ì‹œ ë³´ì¡° íŒë‹¨ìš©)
// - ì‹¤í–‰ ë¡œì§ ìµœì í™”ë¡œ ì†ë„ í–¥ìƒ
// - HTF > í˜„ì¬ TFì¼ ë•Œ ì‹ í˜¸ ë¯¸í‘œì‹œ ì²˜ë¦¬
//
// 2025/10/13 ì—…ë°ì´íŠ¸:
// - ì „ì²´ ë¦¬íŒ©í† ë§: dataclassesë¥¼ ì‚¬ìš©í•œ ë³€ìˆ˜ ì¬êµ¬ì„±
// - ë””ìŠ¤í”Œë ˆì´ ë¡œì§ ì—…ë°ì´íŠ¸: ì…ì¥ ì‹ í˜¸ë¥¼ 1ë´‰ ì•ë‹¹ê²¨ í‘œì‹œ (ë°±í…ŒìŠ¤íŒ… ê°œë°œ í¸ì˜)
// - í˜„ì¬ ì£¼ê¸° ë°˜ì „ì  í‘œì‹œ ë²„ê·¸ ìˆ˜ì •
// - í˜„ì¬ ì£¼ê¸° ë°˜ì „ì  ë¡œì§ ìµœì í™”:
//   * ë°˜í¬ Kì„ ì´ ë°˜í¬í•˜ë©´ì„œ ë™ì‹œì— ldl ë˜ëŠ” luhë¥¼ ëŒíŒŒí•  ë•Œ ldl/luh ë™ê¸° ì—…ë°ì´íŠ¸
//   * í–¥í›„ í€€íŠ¸ ê°œë°œì—ì„œ ë” ì •í™•í•œ ìµì ˆ/ì†ì ˆ ì§€ì  ì„ íƒ ê°€ëŠ¥
//   * í˜„ì¬ ì£¼ê¸°ë§Œ ìˆ˜ì •, HTF1/HTF2ëŠ” ë¯¸ì ìš©
//
// ã€ê¸°íƒ€ ì„¤ëª…ã€‘
// - ì´ ì§€í‘œëŠ” "ì¹´ë“œ(å¡è›‹)" ë¡œì§ ê¸°ë°˜ì´ì§€ë§Œ, ë ˆì´ì•„ì›ƒì€ ë‹¤ë¥¸ ìœ ë£Œ ì§€í‘œ ì°¸ê³ 
// - ê²½ì˜ë¥¼ í‘œí•˜ì—¬ í•´ë‹¹ ì €ìì˜ íŒë§¤ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šê¸° ìœ„í•´ ì•Œë¦¼ ê¸°ëŠ¥ì€ ë¯¸í¬í•¨
// - ì•Œë¦¼ ê¸°ëŠ¥ í•„ìš” ì‹œ ì§ì ‘ ê°œë°œ ê°€ëŠ¥ (ëª‡ ì¤„ì˜ ì½”ë“œë¡œ ê°„ë‹¨íˆ êµ¬í˜„ ê°€ëŠ¥)

//@version=6
indicator("ì¹´ë“œ Kì„  ë°˜ì „-V5", overlay=true, dynamic_requests=true, max_bars_back=500, max_labels_count=300, max_lines_count = 100)


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART1-ì…ë ¥ íŒŒë¼ë¯¸í„°ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// Kì„  ì—…ë°ì´íŠ¸ ë°©ì‹ ì„ íƒ
// ëª¨ë“œ 1: ê·¸ë¦¼ì(ê¼¬ë¦¬) ëŒíŒŒë¡œ ë‹¤ìŒ ìƒìŠ¹/í•˜ë½ Kì„  ì—…ë°ì´íŠ¸ ë° ì „ë‹¬
// ëª¨ë“œ 2: ì‹¤ì²´(ëª¸í†µ) ëŒíŒŒë¡œ ê·¸ë¦¼ìë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì—…ë°ì´íŠ¸
pullbackType = input.string("1", "Kì„  ì—…ë°ì´íŠ¸ ë°©ì‹", ["1", "2"], group = 'ë‹¹å‰å‘¨æœŸ')

// íƒ€ì„í”„ë ˆì„ ì„¤ì •
nowTimeFrame = str.tostring(timeframe.in_seconds() / 60)  // í˜„ì¬ íƒ€ì„í”„ë ˆì„(ë¶„ ë‹¨ìœ„)
higherTimeframe_1 = input.timeframe("15", "HTF_1", group = 'HTF_1')  // ìƒìœ„ íƒ€ì„í”„ë ˆì„ 1
higherTimeframe_2 = input.timeframe("5", "HTF_2", group = 'HTF_2')   // ìƒìœ„ íƒ€ì„í”„ë ˆì„ 2

// HTFì™€ í˜„ì¬ ì£¼ê¸°ì˜ ë°°ìˆ˜ ê´€ê³„ ê³„ì‚° (1ë³´ë‹¤ ì‘ìœ¼ë©´ 1ë¡œ ì„¤ì •)
var int periodMultiple_HTF1 = timeframe.in_seconds(higherTimeframe_1) / timeframe.in_seconds()
var int periodMultiple_HTF2 = timeframe.in_seconds(higherTimeframe_2) / timeframe.in_seconds()
periodMultiple_HTF1 := periodMultiple_HTF1 > 1 ? periodMultiple_HTF1 : 1
periodMultiple_HTF2 := periodMultiple_HTF2 > 1 ? periodMultiple_HTF2 : 1

// ì‹ í˜¸ í‘œì‹œ ì˜µì…˜
showReverse_0 = input.bool(false, 'í˜„ì¬ ì£¼ê¸°ì˜ ë°˜ì „ ì‹¬ë³¼', group = 'ë‹¹å‰å‘¨æœŸ')
showReverse_line_0 = input.bool(true, 'í˜„ì¬ ì£¼ê¸°ì˜ ë³´ì¡° íŒë‹¨ ìˆ˜í‰ì„ ', group = 'ë‹¹å‰å‘¨æœŸ')
showReverse_1 = input.bool(true, 'HTF_1ì˜ ë°˜ì „ ì‹¬ë³¼', group = 'HTF_1')
showReverse_line_1 = input.bool(true, 'HTF_1ì˜ ë³´ì¡° íŒë‹¨ ìˆ˜í‰ì„ ', group = 'HTF_1')
showEntrySignal_1 = input.bool(true, 'HTF_1ì˜ ì§„ì… ì‹ í˜¸', group = 'HTF_1')
showReverse_2 = input.bool(true, 'HTF_2ì˜ ë°˜ì „ ì‹¬ë³¼', group = 'HTF_2')
showReverse_line_2 = input.bool(true, 'HTF_2ì˜ ë³´ì¡° íŒë‹¨ ìˆ˜í‰ì„ ', group = 'HTF_2')
showEntrySignal_2 = input.bool(false, 'HTF_2ì˜ ì§„ì… ì‹ í˜¸', group = 'HTF_2')

// ì•Œë¦¼ ì„¤ì •
enableAlert_0 = input.bool(false, 'í˜„ì¬ ì£¼ê¸° ë°˜ì „ ì•Œë¦¼', group = 'ì•Œë¦¼ ì„¤ì •')
enableAlert_1 = input.bool(true, 'HTF_1 ë°˜ì „ ì•Œë¦¼', group = 'ì•Œë¦¼ ì„¤ì •')
enableAlert_2 = input.bool(false, 'HTF_2 ë°˜ì „ ì•Œë¦¼', group = 'ì•Œë¦¼ ì„¤ì •')
alertFrequency = input.string("ë´‰ë‹¹ 1íšŒ", "ì•Œë¦¼ ë¹ˆë„", ["ë´‰ë‹¹ 1íšŒ", "ì¡°ê±´ë‹¹ 1íšŒ", "ëª¨ë‘"], group = 'ì•Œë¦¼ ì„¤ì •')


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART2-ë³€ìˆ˜ ì„ ì–¸ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// Kì„  ë°ì´í„° êµ¬ì¡°ì²´
// ë°˜ì „ ê³„ì‚° ë° ìœ„ì¹˜ ì¶”ì ì— í•„ìš”í•œ ëª¨ë“  ë°ì´í„° í¬í•¨
type barData
    // ê³„ì‚°ìš© ë°ì´í„°
    float ldh = na              // Last Down High - ìµœê·¼ í•˜ë½ Kì„ ì˜ ê³ ê°€ (ìƒìŠ¹ ë°˜ì „ ê³„ì‚°ìš©)
    float lul = na              // Last Up Low - ìµœê·¼ ìƒìŠ¹ Kì„ ì˜ ì €ê°€ (í•˜ë½ ë°˜ì „ ê³„ì‚°ìš©)
    float ldl = na              // Last Down Low - ìµœê·¼ í•˜ë½ Kì„ ì˜ ì €ê°€ (ì „ë‹¬ìš©)
    float luh = na              // Last Up High - ìµœê·¼ ìƒìŠ¹ Kì„ ì˜ ê³ ê°€ (ì „ë‹¬ìš©)
    int lowest = 0              // ìµœì €ì  ì˜¤í”„ì…‹ ê³„ì‚°ìš©
    int highest = 0             // ìµœê³ ì  ì˜¤í”„ì…‹ ê³„ì‚°ìš©

    // ì¸ë±ìŠ¤ ë§ˆí‚¹ ë°ì´í„° (ë°˜ì „ ìœ„ì¹˜ í‘œì‹œìš©, offset í¬í•¨)
    int ldlIndex = na           // Last Down Low Index - HTF ì£¼ê¸° ìµœê·¼ í•˜ë½ Kì„ ì˜ ì €ê°€ ìœ„ì¹˜
    int luhIndex = na           // Last Up High Index - HTF ì£¼ê¸° ìµœê·¼ ìƒìŠ¹ Kì„ ì˜ ê³ ê°€ ìœ„ì¹˜
    string lastReverseType = na // ìµœê·¼ ë°˜ì „ ìœ í˜•: 'up' ë˜ëŠ” 'down'
    bool isNewBar = true        // Kì„  ì—…ë°ì´íŠ¸ ì—¬ë¶€

// ì‹ í˜¸ ë°ì´í„° êµ¬ì¡°ì²´
// ë¡œì»¬ ë³€ìˆ˜ë¡œ ì‚¬ìš©ë˜ëŠ” ë°˜ì „ ì‹ í˜¸
type signalData
    bool ru = false             // Reverse Up - ìƒìŠ¹ ë°˜ì „ ì‹ í˜¸
    bool rd = false             // Reverse Down - í•˜ë½ ë°˜ì „ ì‹ í˜¸

// ìˆ˜í‰ì„  ë°ì´í„° êµ¬ì¡°ì²´
// ë³´ì¡° íŒë‹¨ì„  ê·¸ë¦¬ê¸°ìš©
type hLineData
    float hLinePrice_ldh = na   // ìƒìŠ¹ ë°˜ì „ ì°¾ê¸°ìš© ê°€ê²© (yì¢Œí‘œ)
    float hLinePrice_lul = na   // í•˜ë½ ë°˜ì „ ì°¾ê¸°ìš© ê°€ê²© (yì¢Œí‘œ)
    int hLineIndex_ldh = na     // ìƒìŠ¹ ë°˜ì „ ì°¾ê¸°ìš© ì¸ë±ìŠ¤ (xì¢Œí‘œ)
    int hLineIndex_lul = na     // í•˜ë½ ë°˜ì „ ì°¾ê¸°ìš© ì¸ë±ìŠ¤ (xì¢Œí‘œ)
    line hLine_ldh = na         // ìƒìŠ¹ ë°˜ì „ ì°¾ê¸°ìš© ìˆ˜í‰ì„  ê°ì²´
    line hLine_lul = na         // í•˜ë½ ë°˜ì „ ì°¾ê¸°ìš© ìˆ˜í‰ì„  ê°ì²´

// ê° íƒ€ì„í”„ë ˆì„ë³„ ë°ì´í„° ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
var barData_0 = barData.new()      // í˜„ì¬ íƒ€ì„í”„ë ˆì„
var barData_1 = barData.new()      // HTF_1
var barData_2 = barData.new()      // HTF_2
signalData_0 = signalData.new()    // í˜„ì¬ íƒ€ì„í”„ë ˆì„ ì‹ í˜¸
signalData_1 = signalData.new()    // HTF_1 ì‹ í˜¸
signalData_2 = signalData.new()    // HTF_2 ì‹ í˜¸
var hLineData_0 = hLineData.new()  // í˜„ì¬ íƒ€ì„í”„ë ˆì„ ìˆ˜í‰ì„ 
var hLineData_1 = hLineData.new()  // HTF_1 ìˆ˜í‰ì„ 
var hLineData_2 = hLineData.new()  // HTF_2 ìˆ˜í‰ì„ 

// ìµœì €/ìµœê³  ì˜¤í”„ì…‹ ê³„ì‚° (ì´ì „ ë´‰ ê¸°ì¤€)
barData_1.lowest := ta.lowestbars(low[1], periodMultiple_HTF1)
barData_1.highest := ta.highestbars(high[1], periodMultiple_HTF1)
barData_2.lowest := ta.lowestbars(low[1], periodMultiple_HTF2)
barData_2.highest := ta.highestbars(high[1], periodMultiple_HTF2)

// Kì„  ì—…ë°ì´íŠ¸ í™•ì¸
barData_0.isNewBar := barstate.isconfirmed           // í˜„ì¬ ë´‰ í™•ì •
barData_1.isNewBar := ta.change(time(higherTimeframe_1)) != 0  // HTF_1 ìƒˆ ë´‰
barData_2.isNewBar := ta.change(time(higherTimeframe_2)) != 0  // HTF_2 ìƒˆ ë´‰


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART3-ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// í•µì‹¬ ë°˜ì „ ì‹ í˜¸ íƒì§€ í•¨ìˆ˜
// ì§€ì •ëœ íƒ€ì„í”„ë ˆì„ì—ì„œ ìƒìŠ¹/í•˜ë½ ë°˜ì „ì„ ê°ì§€í•˜ê³  ê´€ë ¨ ë°ì´í„° ì—…ë°ì´íŠ¸
//
// íŒŒë¼ë¯¸í„°:
//   higherTimeframe: ë¶„ì„í•  íƒ€ì„í”„ë ˆì„
//   pullbackType: Kì„  ì—…ë°ì´íŠ¸ ë°©ì‹ ('1' = ê·¸ë¦¼ì, '2' = ì‹¤ì²´)
//   lastDownHigh, lastUpLow, lastDownLow, lastUpHigh: ì´ì „ Kì„  ë°ì´í„°
//   lastReverseType: ì´ì „ ë°˜ì „ ìœ í˜•
//
// ë°˜í™˜ê°’: [ìƒìŠ¹ë°˜ì „ì‹ í˜¸, í•˜ë½ë°˜ì „ì‹ í˜¸, ldh, lul, ldl, luh, ë°˜ì „ìœ í˜•]
findReverseSignal(higherTimeframe, pullbackType, lastDownHigh, lastUpLow, lastDownLow, lastUpHigh, lastReverseType) =>
    // Kì„  ë°ì´í„° ì—…ë°ì´íŠ¸
    float _high = na
    float _low = na
    float _close = na

    // HTF ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í˜„ì¬ íƒ€ì„í”„ë ˆì„ì´ ì•„ë‹Œ ê²½ìš°)
    if higherTimeframe != nowTimeFrame
        [higherHigh, higherLow, higherClose] = request.security(syminfo.tickerid,
                                                                 higherTimeframe,
                                                                 [high[1], low[1], close[1]],
                                                                 lookahead=barmerge.lookahead_on)
        _high  := higherHigh
        _low   := higherLow
        _close := higherClose
    else
        // í˜„ì¬ íƒ€ì„í”„ë ˆì„ ë°ì´í„° ì‚¬ìš©
        _high := high[0]
        _low := low[0]
        _close := close[0]

    // íŒŒë¼ë¯¸í„° ì´ˆê¸°í™”
    float _lastDownHigh = lastDownHigh
    float _lastUpLow = lastUpLow
    float _lastDownLow = lastDownLow
    float _lastUpHigh = lastUpHigh
    string _lastReverseType = lastReverseType

    // ë°˜ì „ ì‹ í˜¸ ì´ˆê¸°í™”
    bool _reverseUpSignal = false
    bool _reverseDownSignal = false

    // === ìƒìŠ¹ ë°˜ì „ ë˜ëŠ” í•˜ë½ Kì„  íƒìƒ‰ ===
    if _lastReverseType != 'up'
        // ìƒìŠ¹ ë°˜ì „ Kì„  ì¡°ê±´: ì¢…ê°€ê°€ ì´ì „ í•˜ë½ Kì„ ì˜ ê³ ê°€ë¥¼ ëŒíŒŒ
        if _close > _lastDownHigh or na(_lastDownHigh)
            _lastUpLow := _low
            _lastUpHigh := _high
            _lastReverseType := 'up'
            _reverseUpSignal := true

        // í•˜ë½ Kì„  ì—…ë°ì´íŠ¸ (ë°˜ì „ ì—†ì´ í•˜ë½ ì§€ì†)
        else if not na(_lastReverseType)
            if pullbackType == '1'
                // ëª¨ë“œ 1: ê·¸ë¦¼ì(ì €ê°€) ëŒíŒŒ ì‹œ ì—…ë°ì´íŠ¸
                if _low < _lastDownLow and not na(_lastDownLow)
                    _lastDownLow := _low
                    _lastDownHigh := _high

            if pullbackType == '2'
                // ëª¨ë“œ 2: ì‹¤ì²´(ì¢…ê°€) ëŒíŒŒ ì‹œ ì—…ë°ì´íŠ¸
                if _close < _lastDownLow and not na(_lastDownLow)
                    _lastDownLow := _low
                    _lastDownHigh := _high

    // === í•˜ë½ ë°˜ì „ ë˜ëŠ” ìƒìŠ¹ Kì„  íƒìƒ‰ ===
    else if _lastReverseType != 'down'
        // í•˜ë½ ë°˜ì „ Kì„  ì¡°ê±´: ì¢…ê°€ê°€ ì´ì „ ìƒìŠ¹ Kì„ ì˜ ì €ê°€ë¥¼ ëŒíŒŒ
        if _close < _lastUpLow or na(_lastUpLow)
            _lastDownLow := _low
            _lastDownHigh := _high
            _lastReverseType := 'down'
            _reverseDownSignal := true

        // ìƒìŠ¹ Kì„  ì—…ë°ì´íŠ¸ (ë°˜ì „ ì—†ì´ ìƒìŠ¹ ì§€ì†)
        else if not na(_lastReverseType)
            if pullbackType == '1'
                // ëª¨ë“œ 1: ê·¸ë¦¼ì(ê³ ê°€) ëŒíŒŒ ì‹œ ì—…ë°ì´íŠ¸
                if _high > _lastUpHigh and not na(_lastUpHigh)
                    _lastUpLow := _low
                    _lastUpHigh := _high

            if pullbackType == '2'
                // ëª¨ë“œ 2: ì‹¤ì²´(ì¢…ê°€) ëŒíŒŒ ì‹œ ì—…ë°ì´íŠ¸
                if _close > _lastUpHigh and not na(_lastUpHigh)
                    _lastUpLow := _low
                    _lastUpHigh := _high

    [_reverseUpSignal, _reverseDownSignal, _lastDownHigh, _lastUpLow, _lastDownLow, _lastUpHigh, _lastReverseType]


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART4-í•µì‹¬ ê³„ì‚°ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// ã€4.0 í˜„ì¬ íƒ€ì„í”„ë ˆì„ (TF)ã€‘
if barData_0.isNewBar
    // ë°˜ì „ ì‹ í˜¸ íƒì§€ í•¨ìˆ˜ í˜¸ì¶œ
    [reverseUpSignal_val, reverseDownSignal_val,
     lastDownHigh_val, lastUpLow_val,
     lastDownLow_val, lastUpHigh_val,
     lastReverseType_val] = findReverseSignal(nowTimeFrame,
                                                 pullbackType,
                                                 barData_0.ldh,
                                                 barData_0.lul,
                                                 barData_0.ldl,
                                                 barData_0.luh,
                                                 barData_0.lastReverseType
                                                 )
    // ì‹ í˜¸ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
    signalData_0.ru := reverseUpSignal_val
    signalData_0.rd := reverseDownSignal_val

    // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
    barData_0.lastReverseType := lastReverseType_val

    // Kì„  ë°˜ì „ ê³„ì‚°
    // ê²½ìš° 1: í•˜ë½ ë°˜ì „ ë˜ëŠ” í•˜ë½ ì „ë‹¬
    if not(barData_0.ldh == lastDownHigh_val)
        barData_0.ldh := lastDownHigh_val
        barData_0.ldl := lastDownLow_val
        barData_0.ldlIndex := bar_index + barData_0.lowest
        hLineData_0.hLineIndex_ldh := bar_index + barData_0.highest
        hLineData_0.hLinePrice_ldh := high[0 - barData_0.highest]
        hLineData_0.hLinePrice_lul := low[0 - barData_0.lowest]
        // í•˜ë½ ë°˜ì „ ì‹œ ë°˜í¬ Kì„ ì´ ê³ ê°€ë„ ëŒíŒŒí–ˆëŠ”ì§€ í™•ì¸
        barData_0.luh := (signalData_0.rd and lastUpHigh_val < high) ? high :lastUpHigh_val
        barData_0.luhIndex := (signalData_0.rd and lastUpHigh_val < high) ? bar_index : barData_0.luhIndex

    // ê²½ìš° 2: ìƒìŠ¹ ë°˜ì „ ë˜ëŠ” ìƒìŠ¹ ì „ë‹¬
    else if not(barData_0.lul == lastUpLow_val)
        barData_0.lul := lastUpLow_val
        barData_0.luh := lastUpHigh_val
        barData_0.luhIndex := bar_index + barData_0.highest
        hLineData_0.hLineIndex_lul := bar_index + barData_0.lowest
        hLineData_0.hLinePrice_ldh := high[0 - barData_0.highest]
        hLineData_0.hLinePrice_lul := low[0 - barData_0.lowest]
        // ìƒìŠ¹ ë°˜ì „ ì‹œ ë°˜í¬ Kì„ ì´ ì €ê°€ë„ ëŒíŒŒí–ˆëŠ”ì§€ í™•ì¸
        barData_0.ldl := (signalData_0.ru and lastDownLow_val > low) ? low : lastDownLow_val
        barData_0.ldlIndex := (signalData_0.ru and lastDownLow_val > low) ? bar_index : barData_0.ldlIndex


// ã€4.1 ìƒìœ„ íƒ€ì„í”„ë ˆì„ 1 (HTF_1)ã€‘
if barData_0.isNewBar and barData_1.isNewBar
    // ë°˜ì „ ì‹ í˜¸ íƒì§€
    [reverseUpSignal_val, reverseDownSignal_val,
     lastDownHigh_val, lastUpLow_val,
     lastDownLow_val, lastUpHigh_val,
     lastReverseType_val] = findReverseSignal(higherTimeframe_1,
                                                 pullbackType,
                                                 barData_1.ldh,
                                                 barData_1.lul,
                                                 barData_1.ldl,
                                                 barData_1.luh,
                                                 barData_1.lastReverseType
                                                 )
    signalData_1.ru := reverseUpSignal_val
    signalData_1.rd := reverseDownSignal_val

    // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
    barData_1.lastReverseType := lastReverseType_val

    // ë°˜ì „ Kì„  ìœ„ì¹˜ ê³„ì‚°
    if not(barData_1.ldh == lastDownHigh_val)
        barData_1.ldh := lastDownHigh_val
        barData_1.ldl := lastDownLow_val
        barData_1.ldlIndex := bar_index - 1 + barData_1.lowest
        hLineData_1.hLineIndex_ldh := bar_index - 1 + barData_1.highest
        hLineData_1.hLinePrice_ldh := high[1 - barData_1.highest]
        hLineData_1.hLinePrice_lul := low[1 - barData_1.lowest]
    else if not(barData_1.lul == lastUpLow_val)
        barData_1.lul := lastUpLow_val
        barData_1.luh := lastUpHigh_val
        barData_1.luhIndex := bar_index - 1 + barData_1.highest
        hLineData_1.hLineIndex_lul := bar_index - 1 + barData_1.lowest
        hLineData_1.hLinePrice_ldh := high[1 - barData_1.highest]
        hLineData_1.hLinePrice_lul := low[1 - barData_1.lowest]


// ã€4.2 ìƒìœ„ íƒ€ì„í”„ë ˆì„ 2 (HTF_2)ã€‘
if barData_0.isNewBar and barData_2.isNewBar
    // ë°˜ì „ ì‹ í˜¸ íƒì§€
    [reverseUpSignal_val, reverseDownSignal_val,
     lastDownHigh_val, lastUpLow_val,
     lastDownLow_val, lastUpHigh_val,
     lastReverseType_val] = findReverseSignal(higherTimeframe_2,
                                                 pullbackType,
                                                 barData_2.ldh,
                                                 barData_2.lul,
                                                 barData_2.ldl,
                                                 barData_2.luh,
                                                 barData_2.lastReverseType
                                                 )

    signalData_2.ru := reverseUpSignal_val
    signalData_2.rd := reverseDownSignal_val

    // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
    barData_2.lastReverseType := lastReverseType_val

    // ë°˜ì „ Kì„  ìœ„ì¹˜ ê³„ì‚°
    if not(barData_2.ldh == lastDownHigh_val)
        barData_2.ldh := lastDownHigh_val
        barData_2.ldl := lastDownLow_val
        barData_2.ldlIndex := bar_index - 1 + barData_2.lowest
        hLineData_2.hLineIndex_ldh := bar_index - 1 + barData_2.highest
        hLineData_2.hLinePrice_ldh := high[1 - barData_2.highest]
        hLineData_2.hLinePrice_lul := low[1 - barData_2.lowest]
    else if not(barData_2.lul == lastUpLow_val)
        barData_2.lul := lastUpLow_val
        barData_2.luh := lastUpHigh_val
        barData_2.luhIndex := bar_index - 1 + barData_2.highest
        hLineData_2.hLineIndex_lul := bar_index - 1 + barData_2.lowest
        hLineData_2.hLinePrice_ldh := high[1 - barData_2.highest]
        hLineData_2.hLinePrice_lul := low[1 - barData_2.lowest]


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART5-ì°¨íŠ¸ ê·¸ë¦¬ê¸°ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// ã€5.0 í˜„ì¬ íƒ€ì„í”„ë ˆì„ (HTF_0)ã€‘
// í˜„ì¬ ì£¼ê¸° Kì„  ë°˜ì „ ì‹ í˜¸ í‘œì‹œ
if showReverse_0
    if signalData_0.ru
        // ìƒìŠ¹ ë°˜ì „: ì €ê°€ ì•„ë˜ì— ë…¹ìƒ‰ ë¼ë²¨ í‘œì‹œ
        label.new(barData_0.ldlIndex,
                     y=low,
                     yloc=yloc.belowbar,
                     color=color.new(color.green, 70),
                     text='',
                     style=label.style_label_center,
                     size=size.tiny
                     )
    else if signalData_0.rd
        // í•˜ë½ ë°˜ì „: ê³ ê°€ ìœ„ì— ë¹¨ê°„ìƒ‰ ë¼ë²¨ í‘œì‹œ
        label.new(barData_0.luhIndex,
                     y=high,
                     yloc=yloc.abovebar,
                     color=color.new(color.red, 70),
                     text='',
                     style=label.style_label_center,
                     size=size.tiny
                     )

// í˜„ì¬ ì£¼ê¸° ë°˜ì „ íŒë‹¨ ìˆ˜í‰ì„  í‘œì‹œ
if showReverse_line_0
    line.delete(hLineData_0.hLine_ldh)
    line.delete(hLineData_0.hLine_lul)

    // í•˜ë½ ì¶”ì„¸ì¼ ë•Œ: ëŒíŒŒí•´ì•¼ í•  ê³ ê°€ ìˆ˜í‰ì„  (íŒŒë€ìƒ‰)
    hLineData_0.hLine_ldh := line.new(barData_0.lastReverseType == 'down' ? hLineData_0.hLineIndex_ldh : na,
                                         hLineData_0.hLinePrice_ldh,
                                         barData_0.lastReverseType == 'down' ?  bar_index + 5 : na,
                                         hLineData_0.hLinePrice_ldh,
                                         color=color.new(color.blue, 50),
                                         style=line.style_dotted,
                                         width=2
                                         )
    // ìƒìŠ¹ ì¶”ì„¸ì¼ ë•Œ: ëŒíŒŒí•´ì•¼ í•  ì €ê°€ ìˆ˜í‰ì„  (íŒŒë€ìƒ‰)
    hLineData_0.hLine_lul := line.new(barData_0.lastReverseType == 'up' ? hLineData_0.hLineIndex_lul : na,
                                         hLineData_0.hLinePrice_lul,
                                         barData_0.lastReverseType == 'up' ?  bar_index + 5 : na,
                                         hLineData_0.hLinePrice_lul,
                                         color=color.new(color.blue, 50),
                                         style=line.style_dotted,
                                         width=2
                                         )


// ã€5.1 ìƒìœ„ íƒ€ì„í”„ë ˆì„ 1 (HTF_1)ã€‘
// HTF_1 Kì„  ë°˜ì „ ì‹ í˜¸ í‘œì‹œ (ì‚¬ê°í˜• ì‹¬ë³¼)
if barData_1.isNewBar and showReverse_1 and periodMultiple_HTF1 > 1
    if signalData_1.ru
        // ìƒìŠ¹ ë°˜ì „: ë…¹ìƒ‰ ì‚¬ê°í˜•
        label.new(barData_1.ldlIndex,
                     y=low,
                     yloc=yloc.belowbar,
                     color=color.new(color.green, 0),
                     text='',
                     style=label.style_square,
                     size=size.small
                     )
    else if signalData_1.rd
        // í•˜ë½ ë°˜ì „: ë¹¨ê°„ìƒ‰ ì‚¬ê°í˜•
        label.new(barData_1.luhIndex,
                     y=high,
                     yloc=yloc.abovebar,
                     color=color.new(color.red, 0),
                     text='',
                     style=label.style_square,
                     size=size.small
                     )

// HTF_1 ì§„ì… ì‹ í˜¸ í‘œì‹œ (ì‚¼ê°í˜• ì‹¬ë³¼)
// ì‹¤ì œ ê±°ë˜ ì§„ì…ì ì„ ë‚˜íƒ€ëƒ„ (ë°˜ì „ ì‹ í˜¸ë³´ë‹¤ 1ë´‰ ëŠ¦ìŒ)
if showEntrySignal_1 and periodMultiple_HTF1 > 1
    if signalData_1.ru
        // ìƒìŠ¹ ì§„ì…: ë…¹ìƒ‰ ì‚¼ê°í˜• (ìœ„ìª½)
        label.new(x = bar_index,
             y = low,
             yloc = yloc.belowbar,
             text = "",
             style = label.style_triangleup,
             color = color.new(color.green, 0),
             textcolor = color.white,
             size = size.tiny
             )
    if signalData_1.rd
        // í•˜ë½ ì§„ì…: ë¹¨ê°„ìƒ‰ ì‚¼ê°í˜• (ì•„ë˜ìª½)
        label.new(x = bar_index,
             y = high,
             yloc = yloc.abovebar,
             text = "",
             style = label.style_triangledown,
             color = color.new(color.red, 0),
             textcolor = color.white,
             size = size.tiny
             )

// HTF_1 ë°˜ì „ íŒë‹¨ ìˆ˜í‰ì„  í‘œì‹œ
if showReverse_line_1
    line.delete(hLineData_1.hLine_ldh)
    line.delete(hLineData_1.hLine_lul)

    // í•˜ë½ ì¶”ì„¸: ëŒíŒŒí•´ì•¼ í•  ê³ ê°€ì„  (ë¹¨ê°„ìƒ‰)
    hLineData_1.hLine_ldh := line.new(barData_1.lastReverseType == 'down' ? hLineData_1.hLineIndex_ldh : na,
                                         hLineData_1.hLinePrice_ldh,
                                         barData_1.lastReverseType == 'down' ?  bar_index + 5 : na,
                                         hLineData_1.hLinePrice_ldh,
                                         color=color.new(color.red, 50),
                                         style=line.style_dotted,
                                         width=2
                                         )
    // ìƒìŠ¹ ì¶”ì„¸: ëŒíŒŒí•´ì•¼ í•  ì €ê°€ì„  (ë¹¨ê°„ìƒ‰)
    hLineData_1.hLine_lul := line.new(barData_1.lastReverseType == 'up' ? hLineData_1.hLineIndex_lul : na,
                                         hLineData_1.hLinePrice_lul,
                                         barData_1.lastReverseType == 'up' ?  bar_index + 5 : na,
                                         hLineData_1.hLinePrice_lul,
                                         color=color.new(color.red, 50),
                                         style=line.style_dotted,
                                         width=2
                                         )


// ã€5.2 ìƒìœ„ íƒ€ì„í”„ë ˆì„ 2 (HTF_2)ã€‘
// HTF_2 Kì„  ë°˜ì „ ì‹ í˜¸ í‘œì‹œ (X ì‹¬ë³¼)
if barData_2.isNewBar and showReverse_2 and periodMultiple_HTF2 > 1
    if signalData_2.ru
        // ìƒìŠ¹ ë°˜ì „: ë…¹ìƒ‰ X
        label.new(barData_2.ldlIndex,
                     y=low,
                     yloc=yloc.belowbar,
                     color=color.new(color.green, 0),
                     text='',
                     style=label.style_cross,
                     size=size.tiny
                     )
    else if signalData_2.rd
        // í•˜ë½ ë°˜ì „: ë¹¨ê°„ìƒ‰ X
        label.new(barData_2.luhIndex,
                     y=high,
                     yloc=yloc.abovebar,
                     color=color.new(color.red, 0),
                     text='',
                     style=label.style_cross,
                     size=size.tiny
                     )

// HTF_2 ì§„ì… ì‹ í˜¸ í‘œì‹œ (ë¼ë²¨ ì‹¬ë³¼)
if showEntrySignal_2 and periodMultiple_HTF2 > 1
    if signalData_2.ru
        // ìƒìŠ¹ ì§„ì…: ë…¹ìƒ‰ ë¼ë²¨
        label.new(x = bar_index,
             y = low,
             yloc = yloc.belowbar,
             text = "",
             style = label.style_label_up,
             color = color.new(color.green, 0),
             textcolor = color.white,
             size = size.tiny
             )
    if signalData_2.rd
        // í•˜ë½ ì§„ì…: ë¹¨ê°„ìƒ‰ ë¼ë²¨
        label.new(x = bar_index,
             y = high,
             yloc = yloc.abovebar,
             text = "",
             style = label.style_label_down,
             color = color.new(color.red, 0),
             textcolor = color.white,
             size = size.tiny
             )

// HTF_2 ë°˜ì „ íŒë‹¨ ìˆ˜í‰ì„  í‘œì‹œ
if showReverse_line_2
    line.delete(hLineData_2.hLine_ldh)
    line.delete(hLineData_2.hLine_lul)

    // í•˜ë½ ì¶”ì„¸: ëŒíŒŒí•´ì•¼ í•  ê³ ê°€ì„  (ì£¼í™©ìƒ‰)
    hLineData_2.hLine_ldh := line.new(barData_2.lastReverseType == 'down' ? hLineData_2.hLineIndex_ldh : na,
                                         hLineData_2.hLinePrice_ldh,
                                         barData_2.lastReverseType == 'down' ?  bar_index + 5 : na,
                                         hLineData_2.hLinePrice_ldh,
                                         color=color.new(color.orange, 50),
                                         style=line.style_dotted,
                                         width=2
                                         )
    // ìƒìŠ¹ ì¶”ì„¸: ëŒíŒŒí•´ì•¼ í•  ì €ê°€ì„  (ì£¼í™©ìƒ‰)
    hLineData_2.hLine_lul := line.new(barData_2.lastReverseType == 'up' ? hLineData_2.hLineIndex_lul : na,
                                         hLineData_2.hLinePrice_lul,
                                         barData_2.lastReverseType == 'up' ?  bar_index + 5 : na,
                                         hLineData_2.hLinePrice_lul,
                                         color=color.new(color.orange, 50),
                                         style=line.style_dotted,
                                         width=2
                                         )


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART6-ì•Œë¦¼ ê¸°ëŠ¥ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// ì•Œë¦¼ ë¹ˆë„ ì„¤ì •
alertFreq = alertFrequency == "ë´‰ë‹¹ 1íšŒ" ? alert.freq_once_per_bar :
            alertFrequency == "ì¡°ê±´ë‹¹ 1íšŒ" ? alert.freq_once_per_bar_close :
            alert.freq_all

// ã€6.0 í˜„ì¬ íƒ€ì„í”„ë ˆì„ ì•Œë¦¼ã€‘
if enableAlert_0 and barData_0.isNewBar
    if signalData_0.ru
        alert(str.format("ğŸŸ¢ {0} | í˜„ì¬({1}) | ìƒìŠ¹ ë°˜ì „ ë°œìƒ! | ê°€ê²©: {2}",
              syminfo.ticker, timeframe.period, str.tostring(close, format.mintick)), alertFreq)
    if signalData_0.rd
        alert(str.format("ğŸ”´ {0} | í˜„ì¬({1}) | í•˜ë½ ë°˜ì „ ë°œìƒ! | ê°€ê²©: {2}",
              syminfo.ticker, timeframe.period, str.tostring(close, format.mintick)), alertFreq)

// ã€6.1 HTF_1 ì•Œë¦¼ã€‘
if enableAlert_1 and barData_1.isNewBar and periodMultiple_HTF1 > 1
    if signalData_1.ru
        alert(str.format("ğŸŸ¢ {0} | HTF_1({1}) | ìƒìŠ¹ ë°˜ì „ ë°œìƒ! | ê°€ê²©: {2}",
              syminfo.ticker, higherTimeframe_1, str.tostring(close, format.mintick)), alertFreq)
    if signalData_1.rd
        alert(str.format("ğŸ”´ {0} | HTF_1({1}) | í•˜ë½ ë°˜ì „ ë°œìƒ! | ê°€ê²©: {2}",
              syminfo.ticker, higherTimeframe_1, str.tostring(close, format.mintick)), alertFreq)

// ã€6.2 HTF_2 ì•Œë¦¼ã€‘
if enableAlert_2 and barData_2.isNewBar and periodMultiple_HTF2 > 1
    if signalData_2.ru
        alert(str.format("ğŸŸ¢ {0} | HTF_2({1}) | ìƒìŠ¹ ë°˜ì „ ë°œìƒ! | ê°€ê²©: {2}",
              syminfo.ticker, higherTimeframe_2, str.tostring(close, format.mintick)), alertFreq)
    if signalData_2.rd
        alert(str.format("ğŸ”´ {0} | HTF_2({1}) | í•˜ë½ ë°˜ì „ ë°œìƒ! | ê°€ê²©: {2}",
              syminfo.ticker, higherTimeframe_2, str.tostring(close, format.mintick)), alertFreq)


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART7-alertcondition (TradingView ì•Œë¦¼ ì„¤ì •ìš©)ã€‘
////////////////////////////////////////////////////////////////////////////////////////
// TradingViewì—ì„œ ì•Œë¦¼ ìƒì„± ì‹œ ì„ íƒ ê°€ëŠ¥í•œ ì¡°ê±´ë“¤
// ì°¨íŠ¸ì—ì„œ ìš°í´ë¦­ â†’ ì•Œë¦¼ ì¶”ê°€ â†’ ì¡°ê±´ ì„ íƒì—ì„œ ì‚¬ìš©

// í˜„ì¬ íƒ€ì„í”„ë ˆì„
alertcondition(signalData_0.ru and barData_0.isNewBar,
    title="í˜„ì¬ TF ìƒìŠ¹ ë°˜ì „",
    message="ğŸŸ¢ {{ticker}} | í˜„ì¬({{interval}}) | ìƒìŠ¹ ë°˜ì „ | ê°€ê²©: {{close}}")

alertcondition(signalData_0.rd and barData_0.isNewBar,
    title="í˜„ì¬ TF í•˜ë½ ë°˜ì „",
    message="ğŸ”´ {{ticker}} | í˜„ì¬({{interval}}) | í•˜ë½ ë°˜ì „ | ê°€ê²©: {{close}}")

// HTF_1
alertcondition(signalData_1.ru and barData_1.isNewBar and periodMultiple_HTF1 > 1,
    title="HTF_1 ìƒìŠ¹ ë°˜ì „",
    message="ğŸŸ¢ {{ticker}} | HTF_1 | ìƒìŠ¹ ë°˜ì „ | ê°€ê²©: {{close}}")

alertcondition(signalData_1.rd and barData_1.isNewBar and periodMultiple_HTF1 > 1,
    title="HTF_1 í•˜ë½ ë°˜ì „",
    message="ğŸ”´ {{ticker}} | HTF_1 | í•˜ë½ ë°˜ì „ | ê°€ê²©: {{close}}")

// HTF_2
alertcondition(signalData_2.ru and barData_2.isNewBar and periodMultiple_HTF2 > 1,
    title="HTF_2 ìƒìŠ¹ ë°˜ì „",
    message="ğŸŸ¢ {{ticker}} | HTF_2 | ìƒìŠ¹ ë°˜ì „ | ê°€ê²©: {{close}}")

alertcondition(signalData_2.rd and barData_2.isNewBar and periodMultiple_HTF2 > 1,
    title="HTF_2 í•˜ë½ ë°˜ì „",
    message="ğŸ”´ {{ticker}} | HTF_2 | í•˜ë½ ë°˜ì „ | ê°€ê²©: {{close}}")

// ëª¨ë“  ìƒìŠ¹ ë°˜ì „ (í†µí•©)
alertcondition(
    (signalData_0.ru and barData_0.isNewBar) or
    (signalData_1.ru and barData_1.isNewBar and periodMultiple_HTF1 > 1) or
    (signalData_2.ru and barData_2.isNewBar and periodMultiple_HTF2 > 1),
    title="ëª¨ë“  ìƒìŠ¹ ë°˜ì „",
    message="ğŸŸ¢ {{ticker}} | ìƒìŠ¹ ë°˜ì „ ë°œìƒ! | ê°€ê²©: {{close}}")

// ëª¨ë“  í•˜ë½ ë°˜ì „ (í†µí•©)
alertcondition(
    (signalData_0.rd and barData_0.isNewBar) or
    (signalData_1.rd and barData_1.isNewBar and periodMultiple_HTF1 > 1) or
    (signalData_2.rd and barData_2.isNewBar and periodMultiple_HTF2 > 1),
    title="ëª¨ë“  í•˜ë½ ë°˜ì „",
    message="ğŸ”´ {{ticker}} | í•˜ë½ ë°˜ì „ ë°œìƒ! | ê°€ê²©: {{close}}")

// ëª¨ë“  ë°˜ì „ (í†µí•©)
alertcondition(
    (signalData_0.ru and barData_0.isNewBar) or (signalData_0.rd and barData_0.isNewBar) or
    (signalData_1.ru and barData_1.isNewBar and periodMultiple_HTF1 > 1) or
    (signalData_1.rd and barData_1.isNewBar and periodMultiple_HTF1 > 1) or
    (signalData_2.ru and barData_2.isNewBar and periodMultiple_HTF2 > 1) or
    (signalData_2.rd and barData_2.isNewBar and periodMultiple_HTF2 > 1),
    title="ëª¨ë“  ë°˜ì „ (í†µí•©)",
    message="âš¡ {{ticker}} | ë°˜ì „ ë°œìƒ! | ê°€ê²©: {{close}}")
