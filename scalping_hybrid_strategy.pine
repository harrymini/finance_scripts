// ============================================================================
// Pine ScriptÂ® ë¼ì´ì„ ìŠ¤: MIT License
// ì‘ì„±ì: Claude AI
// ë²„ì „: 1.0 (2024)
// ============================================================================
//
// ã€ì „ëµ ì„¤ëª…ã€‘
// Hybrid Scalping Strategy: Heikin Ashi + Squeeze Momentum + EMA Filter
// 1ë¶„ë´‰/3ë¶„ë´‰ ìŠ¤ìº˜í•‘ì— ìµœì í™”ëœ í•˜ì´ë¸Œë¦¬ë“œ ì „ëµ
//
// ã€í•µì‹¬ ê°œë…ã€‘
// 1. Heikin Ashi: ë…¸ì´ì¦ˆ ì œê±°ëœ ìº”ë“¤ë¡œ ì¶”ì„¸ ë°©í–¥ í™•ì¸
// 2. Squeeze Momentum: BBê°€ KC ì•ˆìœ¼ë¡œ ìˆ˜ì¶• í›„ í­ë°œ ì‹œì  í¬ì°©
// 3. EMA 21: ì¶”ì„¸ í•„í„°ë¡œ ì—­ì¶”ì„¸ ì§„ì… ë°©ì§€
//
// ã€ì§„ì… ì¡°ê±´ã€‘
// ë¡±: ìŠ¤í€´ì¦ˆ í•´ì œ + ëª¨ë©˜í…€ ì–‘ìˆ˜ + HA ì–‘ë´‰ + Close > EMA21
// ìˆ: ìŠ¤í€´ì¦ˆ í•´ì œ + ëª¨ë©˜í…€ ìŒìˆ˜ + HA ìŒë´‰ + Close < EMA21
//
// ============================================================================

//@version=6
indicator("Hybrid Scalping: HA + Squeeze + EMA", shorttitle="Hybrid Scalp", overlay=true, max_labels_count=500)


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 1 - ì…ë ¥ íŒŒë¼ë¯¸í„°ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// Heikin Ashi ì„¤ì •
grp_ha = "Heikin Ashi ì„¤ì •"
showHA = input.bool(true, "Heikin Ashi ìº”ë“¤ í‘œì‹œ", group=grp_ha)
haSmoothing = input.int(1, "HA ìŠ¤ë¬´ë”©", minval=1, maxval=5, group=grp_ha, tooltip="ë†’ì„ìˆ˜ë¡ ë¶€ë“œëŸ¬ì›€ (1=ê¸°ë³¸)")

// Squeeze Momentum ì„¤ì •
grp_squeeze = "Squeeze Momentum ì„¤ì •"
bbLength = input.int(20, "BB ê¸¸ì´", minval=5, maxval=50, group=grp_squeeze)
bbMult = input.float(2.0, "BB ë°°ìˆ˜", minval=0.5, maxval=4.0, step=0.1, group=grp_squeeze)
kcLength = input.int(20, "KC ê¸¸ì´", minval=5, maxval=50, group=grp_squeeze)
kcMult = input.float(1.5, "KC ë°°ìˆ˜", minval=0.5, maxval=4.0, step=0.1, group=grp_squeeze)
momLength = input.int(12, "ëª¨ë©˜í…€ ê¸¸ì´", minval=5, maxval=30, group=grp_squeeze)

// EMA í•„í„° ì„¤ì •
grp_ema = "EMA í•„í„° ì„¤ì •"
emaLength = input.int(21, "EMA ê¸¸ì´", minval=5, maxval=100, group=grp_ema)
useEmaFilter = input.bool(true, "EMA í•„í„° ì‚¬ìš©", group=grp_ema)

// ì†ì ˆ/ìµì ˆ ì„¤ì •
grp_risk = "ë¦¬ìŠ¤í¬ ê´€ë¦¬"
atrLength = input.int(14, "ATR ê¸¸ì´", minval=5, maxval=50, group=grp_risk)
slMultiplier = input.float(1.5, "ì†ì ˆ ATR ë°°ìˆ˜", minval=0.5, maxval=5.0, step=0.1, group=grp_risk)
tp1Percent = input.float(0.5, "1ì°¨ ìµì ˆ (%)", minval=0.1, maxval=5.0, step=0.1, group=grp_risk)
tp2Percent = input.float(1.0, "2ì°¨ ìµì ˆ (%)", minval=0.2, maxval=10.0, step=0.1, group=grp_risk)

// í¬ì§€ì…˜ ì„¤ì •
grp_position = "í¬ì§€ì…˜ ì„¤ì •"
positionType = input.string("BOTH", "í¬ì§€ì…˜ íƒ€ì…", options=["LONG", "SHORT", "BOTH"], group=grp_position)

// ì‹œê°í™” ì„¤ì •
grp_visual = "ì‹œê°í™”"
showSignals = input.bool(true, "ë§¤ìˆ˜/ë§¤ë„ ì‹ í˜¸ í‘œì‹œ", group=grp_visual)
showEma = input.bool(true, "EMA ë¼ì¸ í‘œì‹œ", group=grp_visual)
showSqueeze = input.bool(true, "ìŠ¤í€´ì¦ˆ ë°°ê²½ í‘œì‹œ", group=grp_visual)
showStopLoss = input.bool(true, "ì†ì ˆ/ìµì ˆ ë¼ì¸ í‘œì‹œ", group=grp_visual)
showInfoTable = input.bool(true, "ì •ë³´ í…Œì´ë¸” í‘œì‹œ", group=grp_visual)

// ì•Œë¦¼ ì„¤ì •
grp_alert = "ì•Œë¦¼"
enableAlerts = input.bool(true, "ì•Œë¦¼ í™œì„±í™”", group=grp_alert)


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 2 - Heikin Ashi ê³„ì‚°ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// Heikin Ashi ê°’ ê³„ì‚°
haClose = (open + high + low + close) / 4
var float haOpen = na
haOpen := na(haOpen[1]) ? (open + close) / 2 : (haOpen[1] + haClose[1]) / 2
haHigh = math.max(high, math.max(haOpen, haClose))
haLow = math.min(low, math.min(haOpen, haClose))

// ìŠ¤ë¬´ë”© ì ìš© (ì„ íƒì )
haCloseSmooth = ta.sma(haClose, haSmoothing)
haOpenSmooth = ta.sma(haOpen, haSmoothing)

// HA ìº”ë“¤ ë°©í–¥
haBullish = haCloseSmooth > haOpenSmooth
haBearish = haCloseSmooth < haOpenSmooth

// HA ìº”ë“¤ ì‹œê°í™” (overlay)
haColor = haBullish ? color.new(color.teal, 0) : color.new(color.red, 0)
plotcandle(showHA ? haOpenSmooth : na, showHA ? haHigh : na, showHA ? haLow : na, showHA ? haCloseSmooth : na,
           title="Heikin Ashi", color=haColor, wickcolor=haColor, bordercolor=haColor)


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 3 - Squeeze Momentum ê³„ì‚°ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// Bollinger Bands
bbBasis = ta.sma(close, bbLength)
bbDev = bbMult * ta.stdev(close, bbLength)
bbUpper = bbBasis + bbDev
bbLower = bbBasis - bbDev

// Keltner Channel
kcBasis = ta.sma(close, kcLength)
kcRange = ta.atr(kcLength)
kcUpper = kcBasis + kcMult * kcRange
kcLower = kcBasis - kcMult * kcRange

// ìŠ¤í€´ì¦ˆ ìƒíƒœ (BBê°€ KC ì•ˆì— ìˆìœ¼ë©´ ìŠ¤í€´ì¦ˆ)
sqzOn = bbLower > kcLower and bbUpper < kcUpper   // ìŠ¤í€´ì¦ˆ ì¤‘
sqzOff = bbLower < kcLower and bbUpper > kcUpper  // ìŠ¤í€´ì¦ˆ í•´ì œ

// ëª¨ë©˜í…€ ê³„ì‚° (Linear Regression)
highestHigh = ta.highest(high, momLength)
lowestLow = ta.lowest(low, momLength)
avgHL = ta.sma((highestHigh + lowestLow) / 2, momLength)
avgClose = ta.sma(close, momLength)
momentum = ta.linreg(close - ((highestHigh + lowestLow) / 2 + avgClose) / 2, momLength, 0)

// ëª¨ë©˜í…€ ë°©í–¥
momUp = momentum > 0
momDown = momentum < 0
momIncreasing = momentum > momentum[1]
momDecreasing = momentum < momentum[1]

// ìŠ¤í€´ì¦ˆ í•´ì œ ê°ì§€ (ì´ì „ ë´‰ ìŠ¤í€´ì¦ˆ â†’ í˜„ì¬ ë´‰ í•´ì œ)
squeezeFired = sqzOn[1] and sqzOff


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 4 - EMA í•„í„°ã€‘
////////////////////////////////////////////////////////////////////////////////////////

ema21 = ta.ema(close, emaLength)

// EMA í•„í„° ì¡°ê±´
emaLongOk = not useEmaFilter or close > ema21
emaShortOk = not useEmaFilter or close < ema21

// EMA ë¼ì¸ ì‹œê°í™”
plot(showEma ? ema21 : na, "EMA 21", color=color.orange, linewidth=2)


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 5 - ì‹ í˜¸ ìƒì„±ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// ë¡± ì§„ì… ì¡°ê±´
longCondition = (positionType == "LONG" or positionType == "BOTH") and
                sqzOff and                    // ìŠ¤í€´ì¦ˆ í•´ì œ ìƒíƒœ
                momUp and                     // ëª¨ë©˜í…€ ì–‘ìˆ˜
                momIncreasing and             // ëª¨ë©˜í…€ ì¦ê°€ ì¤‘
                haBullish and                 // HA ì–‘ë´‰
                emaLongOk                     // EMA ìœ„

// ìˆ ì§„ì… ì¡°ê±´
shortCondition = (positionType == "SHORT" or positionType == "BOTH") and
                 sqzOff and                   // ìŠ¤í€´ì¦ˆ í•´ì œ ìƒíƒœ
                 momDown and                  // ëª¨ë©˜í…€ ìŒìˆ˜
                 momDecreasing and            // ëª¨ë©˜í…€ ê°ì†Œ ì¤‘
                 haBearish and                // HA ìŒë´‰
                 emaShortOk                   // EMA ì•„ë˜

// ì¤‘ë³µ ì‹ í˜¸ ë°©ì§€
var bool inLongPosition = false
var bool inShortPosition = false
var float entryPrice = na
var float stopLossPrice = na
var float tp1Price = na
var float tp2Price = na

// ATR ê³„ì‚°
atr = ta.atr(atrLength)

// ë¡± ì§„ì…
longEntry = longCondition and not inLongPosition and not inShortPosition
if longEntry
    inLongPosition := true
    entryPrice := close
    stopLossPrice := close - (atr * slMultiplier)
    tp1Price := close * (1 + tp1Percent / 100)
    tp2Price := close * (1 + tp2Percent / 100)

// ìˆ ì§„ì…
shortEntry = shortCondition and not inLongPosition and not inShortPosition
if shortEntry
    inShortPosition := true
    entryPrice := close
    stopLossPrice := close + (atr * slMultiplier)
    tp1Price := close * (1 - tp1Percent / 100)
    tp2Price := close * (1 - tp2Percent / 100)

// ë¡± ì²­ì‚° ì¡°ê±´
longExit = inLongPosition and (close <= stopLossPrice or close >= tp2Price or haBearish or (useEmaFilter and close < ema21))
if longExit
    inLongPosition := false
    entryPrice := na
    stopLossPrice := na
    tp1Price := na
    tp2Price := na

// ìˆ ì²­ì‚° ì¡°ê±´
shortExit = inShortPosition and (close >= stopLossPrice or close <= tp2Price or haBullish or (useEmaFilter and close > ema21))
if shortExit
    inShortPosition := false
    entryPrice := na
    stopLossPrice := na
    tp1Price := na
    tp2Price := na


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 6 - ì‹œê°í™”ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// ìŠ¤í€´ì¦ˆ ë°°ê²½ìƒ‰
bgcolor(showSqueeze and sqzOn ? color.new(color.black, 85) : na, title="ìŠ¤í€´ì¦ˆ ì¤‘")
bgcolor(showSqueeze and squeezeFired and momUp ? color.new(color.green, 90) : na, title="ìƒë°© í­ë°œ")
bgcolor(showSqueeze and squeezeFired and momDown ? color.new(color.red, 90) : na, title="í•˜ë°© í­ë°œ")

// í¬ì§€ì…˜ ë°°ê²½ìƒ‰
bgcolor(inLongPosition ? color.new(color.green, 93) : na, title="ë¡± í¬ì§€ì…˜")
bgcolor(inShortPosition ? color.new(color.red, 93) : na, title="ìˆ í¬ì§€ì…˜")

// ì§„ì… ì‹ í˜¸ ë¼ë²¨
if showSignals and longEntry
    label.new(bar_index, low - atr, "ğŸŸ¢ LONG",
              style=label.style_label_up,
              color=color.new(color.green, 0),
              textcolor=color.white,
              size=size.normal)

if showSignals and shortEntry
    label.new(bar_index, high + atr, "ğŸ”´ SHORT",
              style=label.style_label_down,
              color=color.new(color.red, 0),
              textcolor=color.white,
              size=size.normal)

// ì†ì ˆ/ìµì ˆ ë¼ì¸
plot(showStopLoss and not na(stopLossPrice) ? stopLossPrice : na, "ì†ì ˆ", color=color.red, style=plot.style_linebr, linewidth=1)
plot(showStopLoss and not na(tp1Price) ? tp1Price : na, "ìµì ˆ1", color=color.new(color.green, 50), style=plot.style_linebr, linewidth=1)
plot(showStopLoss and not na(tp2Price) ? tp2Price : na, "ìµì ˆ2", color=color.green, style=plot.style_linebr, linewidth=1)

// ì§„ì…ê°€ ë¼ì¸
plot(not na(entryPrice) ? entryPrice : na, "ì§„ì…ê°€", color=color.blue, style=plot.style_linebr, linewidth=1)


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 7 - í•˜ë‹¨ Squeeze Histogram (ë³„ë„ íŒ¨ë„)ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// ëª¨ë©˜í…€ íˆìŠ¤í† ê·¸ë¨ ìƒ‰ìƒ
momColor = momUp and momIncreasing ? color.lime :
           momUp and momDecreasing ? color.green :
           momDown and momDecreasing ? color.red :
           momDown and momIncreasing ? color.maroon : color.gray

// ìŠ¤í€´ì¦ˆ ìƒíƒœ í‘œì‹œ (ì )
plotshape(sqzOn, "ìŠ¤í€´ì¦ˆ ON", shape.diamond, location.bottom, color.new(color.orange, 0), size=size.tiny)
plotshape(sqzOff and not sqzOn, "ìŠ¤í€´ì¦ˆ OFF", shape.diamond, location.bottom, color.new(color.aqua, 0), size=size.tiny)


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 8 - ì•Œë¦¼ã€‘
////////////////////////////////////////////////////////////////////////////////////////

// Alert conditions
alertcondition(longEntry, title="ë¡± ì§„ì…", message="ğŸŸ¢ {{ticker}} | LONG ì§„ì…! ê°€ê²©: {{close}}")
alertcondition(shortEntry, title="ìˆ ì§„ì…", message="ğŸ”´ {{ticker}} | SHORT ì§„ì…! ê°€ê²©: {{close}}")
alertcondition(squeezeFired, title="ìŠ¤í€´ì¦ˆ í•´ì œ", message="ğŸ’¥ {{ticker}} | ìŠ¤í€´ì¦ˆ í•´ì œ! í­ë°œ ì„ë°•")

// ì‹¤ì‹œê°„ ì•Œë¦¼
if enableAlerts and longEntry
    alert(str.format("ğŸŸ¢ {0} | LONG ì§„ì…\nê°€ê²©: {1}\nì†ì ˆ: {2}\nìµì ˆ: {3}",
          syminfo.ticker, str.tostring(close, format.mintick),
          str.tostring(stopLossPrice, format.mintick),
          str.tostring(tp1Price, format.mintick)), alert.freq_once_per_bar_close)

if enableAlerts and shortEntry
    alert(str.format("ğŸ”´ {0} | SHORT ì§„ì…\nê°€ê²©: {1}\nì†ì ˆ: {2}\nìµì ˆ: {3}",
          syminfo.ticker, str.tostring(close, format.mintick),
          str.tostring(stopLossPrice, format.mintick),
          str.tostring(tp1Price, format.mintick)), alert.freq_once_per_bar_close)

if enableAlerts and squeezeFired
    alert(str.format("ğŸ’¥ {0} | ìŠ¤í€´ì¦ˆ í•´ì œ! ë°©í–¥: {1}",
          syminfo.ticker, momUp ? "ìƒë°© â¬†ï¸" : "í•˜ë°© â¬‡ï¸"), alert.freq_once_per_bar_close)


////////////////////////////////////////////////////////////////////////////////////////
// ã€PART 9 - ì •ë³´ í…Œì´ë¸”ã€‘
////////////////////////////////////////////////////////////////////////////////////////

if showInfoTable
    var table infoTable = table.new(position.top_right, 2, 10, bgcolor=color.new(color.black, 80), border_width=1)

    if barstate.islast
        // í—¤ë”
        table.cell(infoTable, 0, 0, "Hybrid Scalping", text_color=color.white, text_size=size.small)
        table.cell(infoTable, 1, 0, "v1.0", text_color=color.gray, text_size=size.small)

        // Heikin Ashi ìƒíƒœ
        table.cell(infoTable, 0, 1, "HA ì¶”ì„¸", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 1, haBullish ? "ğŸŸ¢ ìƒìŠ¹" : "ğŸ”´ í•˜ë½",
                   text_color=haBullish ? color.green : color.red, text_size=size.tiny)

        // ìŠ¤í€´ì¦ˆ ìƒíƒœ
        sqzStatus = sqzOn ? "ğŸŸ  ìŠ¤í€´ì¦ˆ ì¤‘" : "ğŸ”µ í•´ì œë¨"
        table.cell(infoTable, 0, 2, "ìŠ¤í€´ì¦ˆ", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 2, sqzStatus, text_color=sqzOn ? color.orange : color.aqua, text_size=size.tiny)

        // ëª¨ë©˜í…€
        momStatus = momUp ? (momIncreasing ? "â¬†ï¸ ê°•ì„¸" : "â†—ï¸ ì•½í™”") : (momDecreasing ? "â¬‡ï¸ ê°•ì„¸" : "â†˜ï¸ ì•½í™”")
        table.cell(infoTable, 0, 3, "ëª¨ë©˜í…€", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 3, momStatus, text_color=momUp ? color.green : color.red, text_size=size.tiny)

        // EMA ìƒíƒœ
        emaStatus = close > ema21 ? "ìœ„ â¬†ï¸" : "ì•„ë˜ â¬‡ï¸"
        table.cell(infoTable, 0, 4, "EMA 21", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 4, emaStatus, text_color=close > ema21 ? color.green : color.red, text_size=size.tiny)

        // í¬ì§€ì…˜ ìƒíƒœ
        posStatus = inLongPosition ? "ğŸŸ¢ ë¡±" : inShortPosition ? "ğŸ”´ ìˆ" : "âšª ì—†ìŒ"
        table.cell(infoTable, 0, 5, "í¬ì§€ì…˜", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 5, posStatus, text_color=color.white, text_size=size.tiny)

        // ì§„ì…ê°€
        table.cell(infoTable, 0, 6, "ì§„ì…ê°€", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 6, na(entryPrice) ? "-" : str.tostring(entryPrice, format.mintick),
                   text_color=color.blue, text_size=size.tiny)

        // ì†ì ˆê°€
        table.cell(infoTable, 0, 7, "ì†ì ˆê°€", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 7, na(stopLossPrice) ? "-" : str.tostring(stopLossPrice, format.mintick),
                   text_color=color.red, text_size=size.tiny)

        // ìµì ˆê°€
        table.cell(infoTable, 0, 8, "ìµì ˆ1", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 8, na(tp1Price) ? "-" : str.tostring(tp1Price, format.mintick),
                   text_color=color.green, text_size=size.tiny)

        // ìˆ˜ìµë¥ 
        currentPnL = inLongPosition ? (close - entryPrice) / entryPrice * 100 :
                     inShortPosition ? (entryPrice - close) / entryPrice * 100 : 0.0
        table.cell(infoTable, 0, 9, "ìˆ˜ìµë¥ ", text_color=color.gray, text_size=size.tiny)
        table.cell(infoTable, 1, 9, na(entryPrice) ? "-" : str.tostring(currentPnL, "#.##") + "%",
                   text_color=currentPnL >= 0 ? color.green : color.red, text_size=size.tiny)
